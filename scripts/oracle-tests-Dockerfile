FROM wnameless/oracle-xe-11g

# Replace shell with bash so we can source files
RUN rm /bin/sh && ln -s /bin/bash /bin/sh

# Set debconf to run non-interactively
RUN echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections

RUN apt-get update && apt-get install -y -q --no-install-recommends \
  apt-transport-https \
  build-essential \
  ca-certificates \
  curl \
  git \
  libssl-dev \
  python \
  rsync \
  software-properties-common \
  wget \
  gpg-agent \
  apt-utils \
  && rm -rf /var/lib/apt/lists/*

# Install node 6,8,10 from nvm
RUN curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash

# make sure that there is enough disk...
RUN . $HOME/.nvm/nvm.sh && nvm install 6
RUN . $HOME/.nvm/nvm.sh && nvm install 8
RUN . $HOME/.nvm/nvm.sh && nvm install 10

RUN echo 'module.exports = {\
  oracledb: {\
    user            : "system",\
    password        : "oracle",\
    connectString   : "localhost/XE",\
    stmtCacheSize   : 0,\
    enduser         : "enduser",\
    otherenduser    : "otherenduser",\
  }\
}' > /oracle-config.js

RUN echo $' \n\
  CONNECT system/oracle@localhost/XE \n\
  -- end user \n\
  CREATE USER enduser IDENTIFIED BY "enduser"; \n\
  GRANT CONNECT, RESOURCE TO enduser; \n\
  GRANT CREATE SESSION to enduser; \n\
  GRANT UNLIMITED TABLESPACE TO enduser; \n\
  -- other end user \n\
  CREATE USER otherenduser IDENTIFIED BY "otherenduser"; \n\
  GRANT CONNECT, RESOURCE TO otherenduser; \n\
  GRANT CREATE SESSION to otherenduser; \n\
  GRANT UNLIMITED TABLESPACE TO otherenduser; \n\
  -- grant proxyuser (system) to impersonate enduser/otherenduser \n\
  ALTER USER enduser GRANT CONNECT THROUGH system; \n\
  ALTER USER otherenduser GRANT CONNECT THROUGH system; \n\
  quit \n\
' > /create-proxy-user.sql

ENV ORACLE_HOME /u01/app/oracle/product/11.2.0/xe
ENV ORACLE_SID XE 
ENV OCI_LIB_DIR /u01/app/oracle/product/11.2.0/xe/lib
ENV LD_LIBRARY_PATH /u01/app/oracle/product/11.2.0/xe/lib
ENV KNEX_TEST /oracle-config.js
# sqlite3 seems to be required to certain tests to pass
ENV DB "oracledb sqlite3"
ENV KNEX_TIMEOUT 60000
#ENV DEBUG "knex:oracledb,knex:client,knex:query,knex:bindings,knex:tx"
ENV DEBUG "knex:oracledb,knex:client"

ADD . knex

CMD /usr/sbin/startup.sh && \
  /u01/app/oracle/product/11.2.0/xe/bin/sqlplus -s /nolog @/create-proxy-user.sql && \
  . $HOME/.nvm/nvm.sh && \
  nvm use ${NODE_VER:-10} && \
  cd knex && \
  npm install && \
  npm install oracledb && \
  npm install sqlite3 && \
  npm run build && \
  npm run plaintest  
